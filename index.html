<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amor Engine Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Kelly+Slab&family=Lobster&family=Marck+Script&family=Pacifico&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #ff4d6d;
            --grid-color: #ff4d6d;
        }

        body {
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Segoe UI', sans-serif; overflow: hidden; cursor: none;
            transition: background 0.5s;
            background: linear-gradient(135deg, #fff0f5, #ffdee9);
            background-size: cover;
        }

        .board { 
            display: grid; 
            grid-template-columns: repeat(3, 150px); 
            grid-template-rows: repeat(3, 150px); 
            gap: 20px; 
            z-index: 10; 
            position: relative;
            width: 490px;
            height: 490px;
            -webkit-mask-size: 100% 100%;
            mask-size: 100% 100%;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            background-color: var(--grid-color); 
        }

        .grid-hearts { -webkit-mask-image: url('assets/grid-hearts.svg'); mask-image: url('assets/grid-hearts.svg'); }
        .grid-dots { -webkit-mask-image: url('assets/grid-dots.svg'); mask-image: url('assets/grid-dots.svg'); }
        .grid-neon { -webkit-mask-image: url('assets/grid-neon.svg'); mask-image: url('assets/grid-neon.svg'); }
        
        .cell {
            width: 150px; 
            height: 150px;
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; 
            transition: all 0.3s ease; 
            background: transparent;
            cursor: none;
            user-select: none;
        }

        #custom-cursor {
            position: fixed; width: 60px; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%);
        }

        .particle {
            position: fixed; pointer-events: none; z-index: 9998;
            font-size: 10px; animation: magic 1.5s forwards;
            text-shadow: 0 0 5px white;
        }

        @keyframes magic {
            0% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0) rotate(360deg); opacity: 0; }
        }

        #modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 30px; z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 320px;
        }

        #q-img { max-width: 100%; max-height: 200px; border-radius: 15px; margin-bottom: 10px; display: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; margin-top: 10px; font-weight: bold;}
        #status { font-size: 24px; color: var(--primary); margin-bottom: 20px; font-weight: bold; z-index: 10; text-shadow: 1px 1px 5px white; }
    </style>
</head>
<body id="main-body">

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="board" class="board"></div>

    <div id="modal">
        <h3 id="modal-team" style="color: var(--primary); margin-top: 0;"></h3>
        <img id="q-img" src="">
        <p id="q-text" style="font-size: 18px; margin-top: 5px;"></p>
        <input type="text" id="ans-input" style="width: 80%; padding: 10px; margin-bottom: 10px; border: 2px solid #ffb3c1; border-radius: 10px; outline: none;">
        <br>
        <button class="btn" onclick="check()">–û–¢–í–ï–¢–ò–¢–¨</button>
    </div>

    <img id="custom-cursor" src="">

    <script>
        // –ß–ò–¢–ê–ï–ú –ü–ê–†–ê–ú–ï–¢–†–´
        const p = new URLSearchParams(window.location.search);

        // 2. –ü–†–ò–ú–ï–ù–Ø–ï–ú –í–´–ë–†–ê–ù–ù–´–ô –®–†–ò–§–¢
        const selectedFont = p.get('font');
        if (selectedFont) {
            document.body.style.fontFamily = selectedFont;
        }

        // –ü–†–ò–ú–ï–ù–Ø–ï–ú –¶–í–ï–¢ –°–ï–¢–ö–ò
        const gc = p.get('gc') || 'ff4d6d';
        document.documentElement.style.setProperty('--grid-color', '#' + gc);

        // –£–°–¢–ê–ù–û–í–ö–ê –ö–£–†–°–û–†–û–í
        const cursors = {
            'amor': 'assets/cursor-amor.png',
            'heart': 'assets/cursor-heart.png',
            'arrow': 'assets/cursor-arrow.png'
        };
        const curType = p.get('cur') || 'amor';
        document.getElementById('custom-cursor').src = cursors[curType] || cursors['amor'];
        
        // –£–°–¢–ê–ù–û–í–ö–ê –§–û–ù–ê
        const bgParam = p.get('bg') || 'none';
        const mainBody = document.getElementById('main-body');
        if (bgParam === 'none') {
            mainBody.style.background = 'transparent';
            document.documentElement.style.background = 'transparent';
        } else {
            mainBody.style.backgroundImage = `url('assets/bg-${bgParam}.jpg')`;
            mainBody.style.backgroundSize = 'cover';
            mainBody.style.backgroundPosition = 'center';
        }

        // –°–ï–¢–ö–ê
        const board = document.getElementById('board');
        board.classList.add('grid-' + (p.get('grid') || 'hearts'));

        // 3. –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ö–û–ú–ê–ù–î–´ (–ø—Ä–∏–Ω–∏–º–∞—é—Ç —Å–∏–º–≤–æ–ª –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞)
        const t1 = { 
            name: p.get('t1') || "–ö–æ–º–∞–Ω–¥–∞ 1", 
            sym: p.get('s1') || "‚ù§Ô∏è" 
        };
        const t2 = { 
            name: p.get('t2') || "–ö–æ–º–∞–Ω–¥–∞ 2", 
            sym: p.get('s2') || "‚úâÔ∏è" 
        };
        let cur = 1;

        // –ú–ê–ì–ò–ß–ï–°–ö–ê–Ø –ü–´–õ–¨–¶–ê
        document.addEventListener('mousemove', (e) => {
            const c = document.getElementById('custom-cursor');
            c.style.left = e.clientX + 'px'; c.style.top = e.clientY + 'px';
            if(Math.random() > 0.8) {
                const part = document.createElement('div');
                part.className = 'particle';
                part.innerText = ['‚ú®', 'üíñ', 'üå∏'][Math.floor(Math.random()*3)];
                part.style.left = e.clientX + 'px'; part.style.top = e.clientY + 'px';
                part.style.setProperty('--dx', (Math.random()*100 - 50) + 'px');
                part.style.setProperty('--dy', (Math.random()*100 - 50) + 'px');
                document.body.appendChild(part);
                setTimeout(() => part.remove(), 1200);
            }
        });

        // –°–û–ó–î–ê–ù–ò–ï –ö–õ–ï–¢–û–ö
        const status = document.getElementById('status');
        status.innerText = "–•–æ–¥: " + t1.name;

        for(let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => {
                if(cell.innerText !== "" || board.style.pointerEvents === 'none') return;
                const qData = (p.get('q'+(i+1)) || "||").split('|');
                window.currentQ = { q: qData[0], a: qData[1], img: qData[2] };
                
                document.getElementById('modal').style.display = 'block';
                document.getElementById('q-text').innerText = window.currentQ.q;
                
                const imgTag = document.getElementById('q-img');
                if (window.currentQ.img && window.currentQ.img.length > 10) {
                    imgTag.src = window.currentQ.img;
                    imgTag.style.display = 'block';
                } else {
                    imgTag.style.display = 'none';
                }
                
                document.getElementById('modal-team').innerText = (cur === 1 ? t1.name : t2.name);
                document.getElementById('ans-input').value = "";
                window.activeCell = cell;
            };
            board.appendChild(cell);
        }

        function check() {
            const userAns = document.getElementById('ans-input').value.toLowerCase().trim();
            const correctAns = (window.currentQ.a || "").toLowerCase().trim();

            if(userAns === correctAns || correctAns === "") {
                window.activeCell.innerText = cur === 1 ? t1.sym : t2.sym;
                if(checkWin()) {
                    status.innerText = "üèÜ –ü–û–ë–ï–î–ê: " + (cur === 1 ? t1.name : t2.name);
                    board.style.pointerEvents = 'none';
                    launchCelebrate();
                } else {
                    switchPlayer();
                }
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω–æ!");
                switchPlayer();
            }
            document.getElementById('modal').style.display = 'none';
        }

        function switchPlayer() {
            cur = cur === 1 ? 2 : 1;
            status.innerText = "–•–æ–¥: " + (cur === 1 ? t1.name : t2.name);
        }

        function checkWin() {
            const cells = Array.from(board.children).map(c => c.innerText);
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => cells[w[0]]!=="" && cells[w[0]]===cells[w[1]] && cells[w[1]]===cells[w[2]]);
        }

        function launchCelebrate() {
            const end = Date.now() + 5000;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff4d6d', '#ffffff'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff4d6d', '#ffffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }
    </script>
</body>
</html>

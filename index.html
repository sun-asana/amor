<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amor Engine Final</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #ff4d6d;
            --neon-shadow: 0 0 10px #ff4d6d, 0 0 20px #ff4d6d;
        }

        body {
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Segoe UI', sans-serif; overflow: hidden; cursor: none;
            transition: background 0.5s;
        }

        /* –°–¢–ò–õ–ò –°–ï–¢–û–ö */
        .board { display: grid; grid-template-columns: repeat(3, 110px); gap: 15px; z-index: 10; }
        .grid-dots .cell { border: 3px dashed var(--primary); background: rgba(255,255,255,0.5); }
        .grid-hearts .cell { border: 5px solid #ffb3c1; background: #fff; border-style: double; }
        .grid-neon .cell { border: 2px solid #fff; box-shadow: var(--neon-shadow); background: rgba(0,0,0,0.2); color: #fff; }

        .cell {
            width: 110px; height: 110px; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; transition: all 0.3s ease; background: white;
            cursor: none;
        }

        /* –ú–ê–ì–ò–ß–ï–°–ö–ò–ô –ö–£–†–°–û–† –ò –ü–´–õ–¨–¶–ê */
        #custom-cursor {
            position: fixed; width: 60px; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); filter: drop-shadow(0 0 5px gold);
        }

        .particle {
            position: fixed; pointer-events: none; z-index: 9998;
            font-size: 10px; animation: magic 1.5s forwards;
            text-shadow: 0 0 5px white, 0 0 10px var(--primary);
        }

        @keyframes magic {
            0% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0) rotate(360deg); opacity: 0; }
        }

        /* –û–ö–ù–û –í–û–ü–†–û–°–ê */
        #modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 30px; z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 300px;
        }

        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; margin-top: 10px; font-weight: bold;}
        
        #status { font-size: 24px; color: var(--primary); margin-bottom: 20px; font-weight: bold; z-index: 10; text-shadow: 1px 1px 5px white; }
    </style>
</head>
<body id="main-body">

    <div id="status"></div>
    <div id="board" class="board"></div>

    <div id="modal">
        <h3 id="modal-team" style="color: var(--primary); margin-top: 0;"></h3>
        <p id="q-text" style="font-size: 18px;"></p>
        <input type="text" id="ans-input" style="width: 80%; padding: 10px; margin-bottom: 10px; border: 2px solid #ffb3c1; border-radius: 10px; outline: none;">
        <br>
        <button class="btn" onclick="check()">–û–¢–í–ï–¢–ò–¢–¨</button>
    </div>

    <img id="custom-cursor" src="https://cdn-icons-png.flaticon.com/512/3588/3588640.png">

    <script>
        const p = new URLSearchParams(window.location.search);
        
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–∞
        const bgs = {
            'romance': 'linear-gradient(135deg, #fff0f5, #ffdee9)',
            'science': 'radial-gradient(circle, #ffffff 0%, #ffdee9 100%)',
            'modern': '#ffb3c1'
        };
        document.getElementById('main-body').style.background = bgs[p.get('bg')] || bgs['romance'];

        // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏
        const board = document.getElementById('board');
        board.classList.add('grid-' + (p.get('grid') || 'dots'));

        // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –∏ —Å–∏–º–≤–æ–ª–æ–≤
        const t1 = { name: p.get('t1') || "–ö–æ–º–∞–Ω–¥–∞ 1", sym: p.get('s1') || "‚ù§Ô∏è" };
        const t2 = { name: p.get('t2') || "–ö–æ–º–∞–Ω–¥–∞ 2", sym: p.get('s2') || "‚úâÔ∏è" };
        let cur = 1;

        // 4. –ü—ã–ª—å—Ü–∞
        document.addEventListener('mousemove', (e) => {
            const c = document.getElementById('custom-cursor');
            c.style.left = e.clientX + 'px'; c.style.top = e.clientY + 'px';
            if(Math.random() > 0.7) {
                const part = document.createElement('div');
                part.className = 'particle';
                const types = ['‚ù§Ô∏è', '‚ú®', 'üíñ', 'üå∏'];
                part.innerText = types[Math.floor(Math.random()*types.length)];
                part.style.left = e.clientX + 'px'; part.style.top = e.clientY + 'px';
                part.style.setProperty('--dx', (Math.random()*100 - 50) + 'px');
                part.style.setProperty('--dy', (Math.random()*100 - 50) + 'px');
                document.body.appendChild(part);
                setTimeout(() => part.remove(), 1500);
            }
        });

        // 5. –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
        const status = document.getElementById('status');
        status.innerText = "–•–æ–¥: " + t1.name;

        for(let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.id = i;
            cell.onclick = () => {
                if(cell.innerText !== "") return;
                const qData = (p.get('q'+(i+1)) || "–í–æ–ø—Ä–æ—Å|–û—Ç–≤–µ—Ç").split('|');
                window.currentQ = { q: qData[0], a: qData[1] || "" };
                document.getElementById('modal').style.display = 'block';
                document.getElementById('q-text').innerText = window.currentQ.q;
                document.getElementById('modal-team').innerText = (cur === 1 ? t1.name : t2.name);
                document.getElementById('ans-input').value = "";
                window.activeCell = cell;
            };
            board.appendChild(cell);
        }

        function check() {
            const userAns = document.getElementById('ans-input').value.toLowerCase().trim();
            const correctAns = window.currentQ.a.toLowerCase().trim();

            if(userAns === correctAns || correctAns === "") {
                window.activeCell.innerText = cur === 1 ? t1.sym : t2.sym;
                if(checkWin()) {
                    status.innerText = "üèÜ –ü–û–ë–ï–î–ê: " + (cur === 1 ? t1.name : t2.name);
                    board.style.pointerEvents = 'none';
                    launchCelebrate(); // –ó–ê–ü–£–°–ö –°–ê–õ–Æ–¢–ê
                } else {
                    switchPlayer();
                }
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.");
                switchPlayer();
            }
            document.getElementById('modal').style.display = 'none';
        }

        function switchPlayer() {
            cur = cur === 1 ? 2 : 1;
            status.innerText = "–•–æ–¥: " + (cur === 1 ? t1.name : t2.name);
        }

        function checkWin() {
            const cells = Array.from(board.children).map(c => c.innerText);
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => cells[w[0]]!=="" && cells[w[0]]===cells[w[1]] && cells[w[1]]===cells[w[2]]);
        }

        // –ö–†–ê–°–ò–í–´–ô –°–ê–õ–Æ–¢
        function launchCelebrate() {
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) { return Math.random() * (max - min) + min; }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);

                const particleCount = 50 * (timeLeft / duration);
                // –°–∞–ª—é—Ç —Å–µ—Ä–¥–µ—á–∫–∞–º–∏
                confetti({
                    ...defaults, particleCount,
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 },
                    colors: ['#ff4d6d', '#ffb3c1', '#ff758f'],
                    shapes: ['circle'] // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–∏–±–∞ –¥–µ–ª–∞–µ—Ç –∫—Ä—É–≥–∏, –Ω–æ –º—ã –Ω–∞–∑–æ–≤–µ–º –∏—Ö "–ª–µ–ø–µ—Å—Ç–∫–∞–º–∏"
                });
                confetti({
                    ...defaults, particleCount,
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 },
                    colors: ['#ff4d6d', '#ffb3c1', '#ff758f'],
                    shapes: ['circle']
                });
            }, 250);
        }
    </script>
</body>
</html>

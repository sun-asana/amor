<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amor Engine Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Kelly+Slab&family=Lobster&family=Marck+Script&family=Pacifico&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #ff4d6d;
            --grid-color: #ff4d6d;
            --text-color: #ff4d6d; 
        }

        body {
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Segoe UI', sans-serif; overflow: hidden; cursor: none;
            transition: background 0.5s;
            background: linear-gradient(135deg, #fff0f5, #ffdee9);
            background-size: cover;
            color: var(--text-color);
        }

        .board { 
            display: grid; 
            grid-template-columns: repeat(3, 150px); 
            grid-template-rows: repeat(3, 150px); 
            gap: 20px; 
            z-index: 10; 
            position: relative;
            width: 490px;
            height: 490px;
        }

        .board::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background-color: var(--grid-color);
            -webkit-mask-size: 100% 100%;
            mask-size: 100% 100%;
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
        }

        .grid-hearts::before { -webkit-mask-image: url('assets/grid-hearts.svg'); mask-image: url('assets/grid-hearts.svg'); }
        .grid-dots::before { -webkit-mask-image: url('assets/grid-dots.svg'); mask-image: url('assets/grid-dots.svg'); }
        .grid-neon::before { -webkit-mask-image: url('assets/grid-neon.svg'); mask-image: url('assets/grid-neon.svg'); }
        
        .cell {
            width: 150px; 
            height: 150px;
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; 
            transition: all 0.3s ease; 
            background: transparent;
            cursor: none;
            user-select: none;
            color: var(--text-color);
        }

        #custom-cursor {
            position: fixed; width: 60px; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%);
        }

        .particle {
            position: fixed; pointer-events: none; z-index: 9998;
            font-size: 10px; animation: magic 1.5s forwards;
            text-shadow: 0 0 5px white;
        }

        @keyframes magic {
            0% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0) rotate(360deg); opacity: 0; }
        }

        #modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 30px; z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; width: 320px;
            color: var(--text-color);
        }

        #q-img { max-width: 100%; max-height: 200px; border-radius: 15px; margin-bottom: 10px; display: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 15px; cursor: pointer; margin-top: 10px; font-weight: bold;}
        
      #status { 
    font-size: 24px; 
    color: var(--text-color); 
    padding-top: 10px;    /* –î–æ–±–∞–≤–∏–ª–∏ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–æ –∫ –∫—Ä–∞—é */
    margin-bottom: 10px; 
    font-weight: bold; 
    z-index: 100; 
    text-shadow: 1px 1px 5px white; 
    text-align: center;
    min-height: 1.5em;    /* –†–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ —Ç–µ–∫—Å—Ç */
    width: 100%;          /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    display: block;       /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –±–ª–æ—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç */
}

        @media (max-width: 600px) {
            .board { transform: scale(0.6); transform-origin: center center; }
            #status { font-size: 18px; }
        }
    </style>
</head>
<body id="main-body">

    <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="board" class="board"></div>

    <div id="modal">
        <h3 id="modal-team" style="margin-top: 0; color: inherit;"></h3>
        <img id="q-img" src="">
        <p id="q-text" style="font-size: 18px; margin-top: 5px;"></p>
        <input type="text" id="ans-input" style="width: 80%; padding: 10px; margin-bottom: 10px; border: 2px solid #ffb3c1; border-radius: 10px; outline: none;">
        <br>
        <button class="btn" onclick="check()">–û–¢–í–ï–¢–ò–¢–¨</button>
    </div>

    <img id="custom-cursor" src="">

    <script>
        const p = new URLSearchParams(window.location.search);

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞ –∏ —Ü–≤–µ—Ç–æ–≤
        const selectedFont = p.get('font');
        if (selectedFont) document.body.style.fontFamily = selectedFont;

        const gc = p.get('gc') || 'ff4d6d';
        document.documentElement.style.setProperty('--grid-color', '#' + gc);

        const tc = p.get('tc') || 'ff4d6d';
        document.documentElement.style.setProperty('--text-color', '#' + tc);
        document.documentElement.style.setProperty('--primary', '#' + tc);

        // –ö—É—Ä—Å–æ—Ä
        const cursors = {
            'amor': 'assets/cursor-amor.png',
            'heart': 'assets/cursor-heart.png',
            'arrow': 'assets/cursor-arrow.png'
        };
        const curType = p.get('cur') || 'amor';
        document.getElementById('custom-cursor').src = cursors[curType] || cursors['amor'];
        
        // –§–æ–Ω
        const bgParam = p.get('bg') || 'none';
        const mainBody = document.getElementById('main-body');
        if (bgParam === 'none') {
            mainBody.style.background = 'transparent';
            document.documentElement.style.background = 'transparent';
        } else {
            mainBody.style.backgroundImage = `url('assets/bg-${bgParam}.jpg')`;
            mainBody.style.backgroundSize = 'cover';
        }

        // –°–µ—Ç–∫–∞
        const board = document.getElementById('board');
        board.classList.add('grid-' + (p.get('grid') || 'hearts'));

        // –ö–æ–º–∞–Ω–¥—ã
        const t1 = { name: p.get('t1') || "–ö–æ–º–∞–Ω–¥–∞ 1", sym: p.get('s1') || "‚ù§Ô∏è" };
        const t2 = { name: p.get('t2') || "–ö–æ–º–∞–Ω–¥–∞ 2", sym: p.get('s2') || "‚úâÔ∏è" };
        let cur = 1;

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –∫—É—Ä—Å–æ—Ä–∞
        document.addEventListener('mousemove', (e) => {
            const c = document.getElementById('custom-cursor');
            c.style.left = e.clientX + 'px'; c.style.top = e.clientY + 'px';
            if(Math.random() > 0.8) {
                const part = document.createElement('div');
                part.className = 'particle';
                part.innerText = ['‚ú®', 'üíñ', 'üå∏'][Math.floor(Math.random()*3)];
                part.style.left = e.clientX + 'px'; part.style.top = e.clientY + 'px';
                part.style.setProperty('--dx', (Math.random()*100 - 50) + 'px');
                part.style.setProperty('--dy', (Math.random()*100 - 50) + 'px');
                document.body.appendChild(part);
                setTimeout(() => part.remove(), 1200);
            }
        });

        const status = document.getElementById('status');
        status.innerText = "–•–æ–¥: " + t1.name;

        // –°–æ–∑–¥–∞–Ω–∏–µ —è—á–µ–µ–∫
        for(let i=0; i<9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => {
                if(cell.innerText !== "" || board.style.pointerEvents === 'none') return;
                const qData = (p.get('q'+(i+1)) || "||").split('|');
                window.currentQ = { q: qData[0], a: qData[1], img: qData[2] };
                
                document.getElementById('modal').style.display = 'block';
                document.getElementById('q-text').innerText = window.currentQ.q;
                
                const imgTag = document.getElementById('q-img');
                if (window.currentQ.img && window.currentQ.img.length > 10) {
                    imgTag.src = window.currentQ.img;
                    imgTag.style.display = 'block';
                } else {
                    imgTag.style.display = 'none';
                }
                
                document.getElementById('modal-team').innerText = (cur === 1 ? t1.name : t2.name);
                document.getElementById('ans-input').value = "";
                window.activeCell = cell;
            };
            board.appendChild(cell);
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---

        function check() {
            const userAns = document.getElementById('ans-input').value.toLowerCase().trim();
            const correctAns = (window.currentQ.a || "").toLowerCase().trim();

            if(userAns === correctAns || correctAns === "") {
                window.activeCell.innerText = cur === 1 ? t1.sym : t2.sym;
                
                if(checkWin()) {
                    const winnerName = (cur === 1 ? t1.name : t2.name);
                    status.innerHTML = `üèÜ <span style="font-size: 1.2em;">${winnerName}</span><br>–õ—é–±–æ–≤—å –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ! ‚ú®`;
                    board.style.pointerEvents = 'none';
                    launchCelebrate();
                } else if (Array.from(board.children).every(c => c.innerText !== "")) {
                    status.innerHTML = "ü§ù <span style='font-size: 1.2em;'>–ù–ò–ß–¨–Ø!</span><br>–ü–æ–±–µ–¥–∏–ª–∞ –¥—Ä—É–∂–±–∞ –∏ –ê–º—É—Ä! üíñ";
                    board.style.pointerEvents = 'none';
                } else {
                    switchPlayer();
                }
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω–æ!");
                switchPlayer();
            }
            document.getElementById('modal').style.display = 'none';
        }

        function switchPlayer() {
            cur = cur === 1 ? 2 : 1;
            status.innerText = "–•–æ–¥: " + (cur === 1 ? t1.name : t2.name);
        }

        function checkWin() {
            const cells = Array.from(board.children).map(c => c.innerText);
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => cells[w[0]]!=="" && cells[w[0]]===cells[w[1]] && cells[w[1]]===cells[w[2]]);
        }

        function launchCelebrate() {
            const end = Date.now() + 5000;
            const mainColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
            
            (function frame() {
                confetti({ 
                    particleCount: 7, 
                    angle: 60, 
                    spread: 55, 
                    origin: { x: 0 }, 
                    colors: [mainColor, '#ffffff', '#ffb3c1'] 
                });
                confetti({ 
                    particleCount: 7, 
                    angle: 120, 
                    spread: 55, 
                    origin: { x: 1 }, 
                    colors: [mainColor, '#ffffff', '#ffb3c1'] 
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }
    </script>
</body>
</html>
